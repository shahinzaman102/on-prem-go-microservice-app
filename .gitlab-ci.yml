image: shahinzaman/runner-tools:latest

variables:
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"

stages:
  - build
  - deploy

before_script:
  - export HOME=/root
  - mkdir -p /home/shahinzaman
  - ln -s /root/.minikube /home/shahinzaman/.minikube || true
  - ln -s /root/.kube /home/shahinzaman/.kube || true
  - eval $(minikube -p minikube docker-env)
  - echo "DOCKER_HOST is $DOCKER_HOST"
  - echo "Docker Cert Path -> $DOCKER_CERT_PATH"
  - ls -l $DOCKER_CERT_PATH
  - docker info
  - docker ps

build:
  stage: build
  tags:
    - docker
  script:
    - echo "üèóÔ∏è Building Docker images..."
    - |
      for service in authentication-service broker-service front-end listener-service logger-service mailer-service; do
        echo "üî® Building $service..."
        docker build -t $service:$IMAGE_TAG "$CI_PROJECT_DIR/$service" || exit 1
      done
  after_script:
    - docker system prune -f --volumes

deploy:
  stage: deploy
  tags:
    - docker
  script:
    - echo "üîê Creating Kubernetes secrets from CI/CD variables..."

    - |
      kubectl delete secret postgres-secrets --ignore-not-found

      kubectl create secret generic postgres-secrets \
        --from-literal=POSTGRES_USER="$POSTGRES_USER" \
        --from-literal=POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
        --from-literal=POSTGRES_DB="$POSTGRES_DB"

    - |
      kubectl delete secret pgadmin-secrets --ignore-not-found
      kubectl create secret generic pgadmin-secrets \
        --from-literal=PGADMIN_USER="$PGADMIN_USER" \
        --from-literal=PGADMIN_PASSWORD="$PGADMIN_PASSWORD"

    - |
      kubectl delete secret mongo-secrets --ignore-not-found
      kubectl create secret generic mongo-secrets \
        --from-literal=MONGO_INITDB_ROOT_USERNAME="$MONGO_INITDB_ROOT_USERNAME" \
        --from-literal=MONGO_INITDB_ROOT_PASSWORD="$MONGO_INITDB_ROOT_PASSWORD"

    - |
      kubectl delete secret mailer-secrets --ignore-not-found
      kubectl create secret generic mailer-secrets \
        --from-literal=MAIL_USERNAME="$MAIL_USERNAME" \
        --from-literal=MAIL_PASSWORD="$MAIL_PASSWORD"

    - |
      kubectl delete secret user-secrets --ignore-not-found
      kubectl create secret generic user-secrets \
        --from-literal=USER_EMAIL="$USER_EMAIL" \
        --from-literal=USER_PASSWORD="$USER_PASSWORD"

    - echo "üåÄ Substituting Kubernetes manifests..."
    - |
      for file in ${CI_PROJECT_DIR}/config/k8s/*.yml; do
        envsubst < "$file" > "${file%.yml}_deployment.yaml"
      done
    - echo "üöÄ Applying manifests to Minikube..."
    - |
      for file in ${CI_PROJECT_DIR}/config/k8s/*_deployment.yaml; do
        kubectl apply -f "$file" || exit 1
      done
    - echo "üåê Applying app-ingress.yaml..."
    - kubectl apply -f ${CI_PROJECT_DIR}/config/app-ingress.yml

  after_script:
    - echo "üßπ Cleaning up..."
    - rm -f ${CI_PROJECT_DIR}/config/k8s/*_deployment.yaml
